#!/usr/bin/env python
from cfuploader.app import *
import sys
import os

if __name__ == "__main__":
    pid = os.getpid()

    printf("pid = %i\n", pid)
    conf = Config()
    #daemonize this stuff
    printf("going into daemon mode log file is %s\n", conf.log_file)
    if os.fork():
        os._exit(0)

    os.setsid()

    if os.fork():
        os._exit(0)

    os.chdir("/")
    os.umask(0)

    #redirect stdout and stderr to the log file descriptor.
    fp = open(conf.log_file,"a")
    os.dup2(fp.fileno(), sys.stdout.fileno())
    os.dup2(fp.fileno(), sys.stderr.fileno())
    fp.close() #Close the extra file descriptor

    #logging pid to run file
    open(conf.run_file, "w").write("%s"%os.getpid())

    #Starting up the app
    uploader = Uploader()
    uploader.main_loop()

